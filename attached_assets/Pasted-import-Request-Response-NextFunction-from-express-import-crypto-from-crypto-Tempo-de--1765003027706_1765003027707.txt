import { Request, Response, NextFunction } from "express";
import crypto from "crypto";
// Tempo de expiraÃ§Ã£o do cookie (3 horas)
const COOKIE_MAX_AGE = 3 * 60 * 60 * 1000; // 10800 segundos em ms
const COOKIE_NAME = "creative_session";
const COOKIE_VALUE = "authorized";
interface CloakerOptions {
  tokenOffer?: string;
  blockUrl?: string;
  enabled?: boolean;
}
/**
 * Obter secrets do ambiente
 */
function getEnvSecrets(): { tokenOffer: string | undefined; blockUrl: string | undefined } {
  return {
    tokenOffer: process.env.TOKEN_OFFER,
    blockUrl: process.env.BLOCK_URL,
  };
}
/**
 * Verificar se estÃ¡ em ambiente Replit (desenvolvimento)
 * Desativa o cloaker para facilitar desenvolvimento
 */
function isReplitEnvironment(): boolean {
  return !!(process.env.REPL_ID || process.env.REPL_SLUG);
}
/**
 * Verificar se a rota deve ser ignorada pelo cloaker
 */
function isIgnoredRoute(path: string): boolean {
  const ignoredPrefixes = ["/static/", "/api/", "/assets/", "/fonts/"];
  const ignoredExact = ["/favicon.ico", "/robots.txt"];
  for (const prefix of ignoredPrefixes) {
    if (path.startsWith(prefix)) {
      return true;
    }
  }
  if (ignoredExact.includes(path)) {
    return true;
  }
  return false;
}
/**
 * Validar token usando comparaÃ§Ã£o segura (timing-safe)
 */
function validateToken(providedToken: string, expectedToken: string): boolean {
  if (!providedToken || !expectedToken) {
    return false;
  }
  // Usar crypto.timingSafeEqual para comparaÃ§Ã£o segura contra timing attacks
  try {
    const provided = Buffer.from(String(providedToken), "utf-8");
    const expected = Buffer.from(String(expectedToken), "utf-8");
    // Ambos devem ter o mesmo tamanho para timingSafeEqual
    if (provided.length !== expected.length) {
      return false;
    }
    return crypto.timingSafeEqual(provided, expected);
  } catch {
    return false;
  }
}
/**
 * Extrair parÃ¢metro creative da URL
 */
function getCreativeParam(req: Request): string {
  return (req.query.creative as string)?.trim() || "";
}
/**
 * Verificar se o cookie de sessÃ£o Ã© vÃ¡lido
 */
function hasValidCookie(req: Request): boolean {
  return req.cookies[COOKIE_NAME] === COOKIE_VALUE;
}
/**
 * Criar redirecionamento removendo o parÃ¢metro creative da URL
 */
function createRedirectWithoutParam(url: string): string {
  const urlObj = new URL(url, "http://localhost");
  urlObj.searchParams.delete("creative");
  return urlObj.pathname + (urlObj.search ? urlObj.search : "");
}
/**
 * Definir cookie de autenticaÃ§Ã£o
 */
function setAuthCookie(res: Response): void {
  const isProduction = process.env.NODE_ENV === "production";
  res.cookie(COOKIE_NAME, COOKIE_VALUE, {
    maxAge: COOKIE_MAX_AGE,
    httpOnly: true,
    secure: isProduction, // Secure apenas em produÃ§Ã£o
    sameSite: "lax", // Permite cookies de sites externos (ex: Facebook Ads, Google Ads)
  });
}
/**
 * Bloquear acesso redirecionando para BLOCK_URL
 */
function blockAccess(res: Response, blockUrl: string | undefined, reason: string): void {
  if (blockUrl) {
    console.log(`[CLOAKER] Acesso bloqueado - Motivo: ${reason} - Redirecionando para: ${blockUrl}`);
    res.redirect(302, blockUrl);
  } else {
    console.log(`[CLOAKER] Acesso bloqueado - Motivo: ${reason} - BLOCK_URL nÃ£o configurada`);
    res.status(403).send("Access Denied");
  }
}
/**
 * Middleware de cloaker (Sistema de controle de acesso)
 * 
 * FLUXO:
 * 1. Se Replit (REPL_ID/REPL_SLUG): Acesso livre (desenvolvimento)
 * 2. Se rota ignorada (/api, /assets, etc): Acesso livre
 * 3. Se cookie vÃ¡lido: Acesso livre
 * 4. Se parÃ¢metro creative com token correto: Criar cookie e redirecionar
 * 5. Se parÃ¢metro creative com token incorreto: Bloquear
 * 6. Sem cookie e sem parÃ¢metro: Bloquear
 */
export function cloakerMiddleware(options: CloakerOptions = {}): (req: Request, res: Response, next: NextFunction) => void {
  return (req: Request, res: Response, next: NextFunction) => {
    const path = req.path;
    // ========================================
    // ETAPA 1: Detectar ambiente Replit
    // ========================================
    // Desativar cloaker apenas no ambiente Replit (desenvolvimento)
    // Quando publicado, essas variÃ¡veis nÃ£o existem e o cloaker fica ativo
    if (isReplitEnvironment()) {
      console.log("[CLOAKER] Detectado ambiente Replit - Modo desenvolvimento: acesso permitido sem autenticaÃ§Ã£o");
      return next();
    }
    // ========================================
    // ETAPA 2: Verificar rotas ignoradas
    // ========================================
    if (isIgnoredRoute(path)) {
      console.log(`[CLOAKER] Rota ignorada: ${path} - Acesso permitido`);
      return next();
    }
    const { tokenOffer, blockUrl } = options.tokenOffer ? options : getEnvSecrets();
    // ========================================
    // ETAPA 3: Verificar cookie de sessÃ£o
    // ========================================
    if (hasValidCookie(req)) {
      console.log(`[CLOAKER] Cookie vÃ¡lido detectado - Acesso permitido para: ${path}`);
      return next();
    }
    // ========================================
    // ETAPA 4: Verificar parÃ¢metro creative
    // ========================================
    const creativeParam = getCreativeParam(req);
    if (creativeParam) {
      // Validar token
      if (tokenOffer && validateToken(creativeParam, tokenOffer)) {
        // Token vÃ¡lido - criar cookie e redirecionar sem o parÃ¢metro
        setAuthCookie(res);
        const redirectUrl = createRedirectWithoutParam(req.originalUrl);
        console.log(`[CLOAKER] Token vÃ¡lido - Criando cookie e redirecionando para: ${redirectUrl}`);
        return res.redirect(302, redirectUrl);
      } else {
        // Token invÃ¡lido - bloquear
        return blockAccess(res, blockUrl, "INVALID_TOKEN");
      }
    }
    // ========================================
    // ETAPA 5: Bloquear acesso nÃ£o autorizado
    // ========================================
    // Sem cookie e sem parÃ¢metro creative - bloquear
    return blockAccess(res, blockUrl, "ACCESS_DENIED - Sem token e sem cookie vÃ¡lido");
  };
}
/**
 * Inicializar sistema de cloaker
 */
export function initCloaker(tokenOffer?: string, blockUrl?: string): void {
  const isReplit = isReplitEnvironment();
  console.log("[CLOAKER] Sistema de cloaker inicializado");
  if (isReplit) {
    console.log("[CLOAKER] Ambiente: REPLIT (Desenvolvimento) - Cloaker DESATIVADO para desenvolvimento livre");
  } else {
    console.log("[CLOAKER] Ambiente: PRODUÃ‡ÃƒO - Cloaker ATIVO e bloqueando acessos sem autenticaÃ§Ã£o");
  }
  if (tokenOffer) {
    console.log(`[CLOAKER] TOKEN_OFFER configurado: ${tokenOffer.substring(0, 8)}...`);
  }
  if (blockUrl) {
    console.log(`[CLOAKER] BLOCK_URL configurada: ${blockUrl}`);
  }
  console.log(`[CLOAKER] Cookie vÃ¡lido por: ${COOKIE_MAX_AGE / 1000}s (3 horas)`);
}

2ï¸âƒ£ Atualizar server/app.ts (integraÃ§Ã£o com o cloaker)
Adicione no inÃ­cio do arquivo (apÃ³s imports):

import { cloakerMiddleware, initCloaker } from "./middleware/cloaker";
import cookieParser from "cookie-parser";
export const app = express();
// Inicializar cloaker se TOKEN_OFFER ou BLOCK_URL estiverem configurados
const tokenOffer = process.env.TOKEN_OFFER;
const blockUrl = process.env.BLOCK_URL;
if (tokenOffer || blockUrl) {
  initCloaker(tokenOffer, blockUrl);
}
// Middleware para parsing de cookies (DEVE vir ANTES do cloaker)
app.use(cookieParser());
// Middleware de cloaker (controle de acesso)
app.use(cloakerMiddleware({ tokenOffer, blockUrl, enabled: tokenOffer || blockUrl ? true : false }));

3ï¸âƒ£ VariÃ¡veis de Ambiente NecessÃ¡rias
Configure no Replit Secrets:

TOKEN_OFFER=seu_token_secreto_aqui
BLOCK_URL=https://www.gov.br/pt-br

Exemplo de tokens:

TOKEN_OFFER=meta_ads_campaign_2024_secret_token_123456
TOKEN_OFFER=test_token_secret_123

ğŸ“‹ COMO FUNCIONA O CLOAKER
FLUXO DE ACESSO:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    UsuÃ¡rio tenta acessar pÃ¡gina         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Ã‰ ambiente Replit (desenvolvimento)?   â”‚
â”‚           SIM â†’ Permite                 â”‚
â”‚           NÃƒO â†’ Continua                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Rota Ã© ignorada (/api, /assets)?       â”‚
â”‚           SIM â†’ Permite                 â”‚
â”‚           NÃƒO â†’ Continua                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Cookie vÃ¡lido existe?                  â”‚
â”‚           SIM â†’ Permite                 â”‚
â”‚           NÃƒO â†’ Continua                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  URL tem parÃ¢metro ?creative=TOKEN?     â”‚
â”‚           SIM â†’ Valida token            â”‚
â”‚           NÃƒO â†’ Bloqueia                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
        SIM/NÃƒO
        /    \
       â–¼      â–¼
    Token   Token
    vÃ¡lido  invÃ¡lido
     â”‚        â”‚
     â–¼        â–¼
  Cria    Bloqueia
  Cookie  Redirecion
  &       para
  Redireciona BLOCK_URL

ğŸš€ COMO IMPLEMENTAR EM SEU PROJETO
Passo 1: Criar o arquivo middleware
Crie a pasta server/middleware (se nÃ£o existir)
Crie o arquivo server/middleware/cloaker.ts
Copie o cÃ³digo completo acima
Passo 2: Integrar em server/app.ts
Adicione no topo:

import { cloakerMiddleware, initCloaker } from "./middleware/cloaker";
import cookieParser from "cookie-parser";

E apÃ³s criar const app = express():

// Inicializar cloaker se TOKEN_OFFER ou BLOCK_URL estiverem configurados
const tokenOffer = process.env.TOKEN_OFFER;
const blockUrl = process.env.BLOCK_URL;
if (tokenOffer || blockUrl) {
  initCloaker(tokenOffer, blockUrl);
}
// Middleware para parsing de cookies (DEVE vir ANTES do cloaker)
app.use(cookieParser());
// Middleware de cloaker (controle de acesso)
app.use(cloakerMiddleware({ tokenOffer, blockUrl, enabled: tokenOffer || blockUrl ? true : false }));

Passo 3: Configurar Secrets
VÃ¡ para Secrets â†’ Add Secret
TOKEN_OFFER: seu token secreto
BLOCK_URL: URL para bloquear acesso
Passo 4: Usar no seu projeto
A partir de entÃ£o, o cloaker protegerÃ¡ automaticamente:

# SEM token (bloqueado)
https://seu-app.replit.dev/
# âŒ Bloqueado â†’ Redireciona para BLOCK_URL
# COM token correto (permite)
https://seu-app.replit.dev/?creative=seu_token_secreto_aqui
# âœ… Cria cookie â†’ Redireciona sem o parÃ¢metro
# âœ… Acesso livre por 3 horas
# API sempre liberada
https://seu-app.replit.dev/api/algo
# âœ… Sempre permite (nÃ£o requer autenticaÃ§Ã£o)

ğŸ” RECURSOS DO CLOAKER
Recurso	DescriÃ§Ã£o
Token Timing-Safe	ComparaÃ§Ã£o segura contra timing attacks
Cookie 3h	SessÃ£o vÃ¡lida por 3 horas
Rota Ignorada	/api/*, /assets/*, /static/* sempre liberadas
Ambiente Replit	Desativa automaticamente em desenvolvimento
Seguro em ProduÃ§Ã£o	Ativa ao publicar
Redirect Clean	Remove ?creative=TOKEN apÃ³s validaÃ§Ã£o
HttpOnly Cookie	Protegido contra XSS
ğŸ“Š EXEMPLO DE USO
URL de Acesso com Token:
https://seu-app.replit.dev/?creative=seu_token_secreto_aqui_123456

ApÃ³s autenticaÃ§Ã£o (cookie vÃ¡lido):
https://seu-app.replit.dev/
# âœ… Acesso livre durante 3 horas

Sem token (bloqueado):
https://seu-app.replit.dev/
# âŒ Redireciona para https://www.gov.br/pt-br

